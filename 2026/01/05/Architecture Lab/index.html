
<!DOCTYPE html><html lang="en" data-theme="light">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.33.1" theme-name="Stellar" theme-version="1.33.1">
  
  
  <meta name="generator" content="Hexo 8.1.1">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  <link rel="preconnect" href="https://gcore.jsdelivr.net" crossorigin><link rel="preconnect" href="https://unpkg.com" crossorigin><link rel="preconnect" href="https://cdn.bootcdn.net" crossorigin>
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  <meta name="theme-color" content="#f9fafb">
  <title>CMU CS:APP Architecture Lab - SUNCHAOYI</title>

  
    <meta name="description" content="CS:APP Architecture Lab ReportName SUNCHAOYI   To fix the build error with older versions of GCC, you’ll need to add the -fcommon to the compiler settings in misc&#x2F;Makefile, pipe&#x2F;Makefile and seq&#x2F;Makef">
<meta property="og:type" content="article">
<meta property="og:title" content="CMU CS:APP Architecture Lab">
<meta property="og:url" content="https://sunchaoyi923.github.io/2026/01/05/Architecture%20Lab/">
<meta property="og:site_name" content="SUNCHAOYI">
<meta property="og:description" content="CS:APP Architecture Lab ReportName SUNCHAOYI   To fix the build error with older versions of GCC, you’ll need to add the -fcommon to the compiler settings in misc&#x2F;Makefile, pipe&#x2F;Makefile and seq&#x2F;Makef">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2026-01-04T16:00:00.000Z">
<meta property="article:modified_time" content="2026-01-25T11:16:26.620Z">
<meta property="article:author" content="Chaoyi, Sun">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  

  <!-- feed -->
  

  <link rel="stylesheet" href="/css/main.css?v=1.33.1">


  
    <link rel="shortcut icon" href="/img/Favicon.png">
  

  

  <script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Chaoyi, Sun","sameAs":[]},"dateCreated":"2026-01-05T00:00:00+08:00","dateModified":"2026-01-25T19:16:26+08:00","datePublished":"2026-01-05T00:00:00+08:00","description":"","headline":"CMU CS:APP Architecture Lab","mainEntityOfPage":{"@type":"WebPage","@id":"https://sunchaoyi923.github.io/2026/01/05/Architecture%20Lab/"},"publisher":{"@type":"Organization","name":"Chaoyi, Sun","sameAs":[]},"url":"https://sunchaoyi923.github.io/2026/01/05/Architecture%20Lab/","thumbnailUrl":"/img/CUHKSZ.jpg","image":1}</script>
  <link rel="shortcut icon" href="/img/Avatar.jpg"><meta name="theme-color" content="#f8f8f8"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/style.min.css" media="all" />
</head>
<body><div class="sitebg"><div class="siteblur"></div></div>

<div class="l_body content" id="start" layout="post" type="tech" ><aside class="l_left"><div class="sidebg"></div><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><div class="icon"><img no-lazy class="icon" src="/img/Avatar.jpg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></div><a class="title" href="/"><div class="main">超闻逸事</div><div class="sub normal cap">Life & Academy</div><div class="sub hover cap" style="opacity:0"> Designed by SUNCHAOYI</div></a></div></header>

<div class="nav-area">

<nav class="menu dis-select"><a class="nav-item" title="Self-Introduction" href="/Myself/" style="color:#3DC550"><img no-lazy src="/img/me.jpg" / onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="nav-item" title="Blog" href="/" style="color:#1BCDFC"><img no-lazy src="/img/post.jpg" / onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="nav-item" title="Favorite" href="/favorite/" style="color:#F44336"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m13.629 20.472l-.542.916c-.483.816-1.69.816-2.174 0l-.542-.916c-.42-.71-.63-1.066-.968-1.262c-.338-.197-.763-.204-1.613-.219c-1.256-.021-2.043-.098-2.703-.372a5 5 0 0 1-2.706-2.706C2 14.995 2 13.83 2 11.5v-1c0-3.273 0-4.91.737-6.112a5 5 0 0 1 1.65-1.651C5.59 2 7.228 2 10.5 2h3c3.273 0 4.91 0 6.113.737a5 5 0 0 1 1.65 1.65C22 5.59 22 7.228 22 10.5v1c0 2.33 0 3.495-.38 4.413a5 5 0 0 1-2.707 2.706c-.66.274-1.447.35-2.703.372c-.85.015-1.275.022-1.613.219c-.338.196-.548.551-.968 1.262" opacity=".5"/><path fill="currentColor" d="M10.99 14.308c-1.327-.978-3.49-2.84-3.49-4.593c0-2.677 2.475-3.677 4.5-1.609c2.025-2.068 4.5-1.068 4.5 1.609c0 1.752-2.163 3.615-3.49 4.593c-.454.335-.681.502-1.01.502c-.329 0-.556-.167-1.01-.502"/></svg></a></nav>
</div>
<div class="widgets">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="Search"></form><div id="search-result"></div><div class="search-no-result">No Results!</div></div>



<widget class="widget-wrapper recent post-list"><div class="widget-header dis-select"><span class="name">Recent Update</span></div><div class="widget-body fs14"><a class="item title" href="/2022/10/04/NOIP2022/"><span class="title">2022 NOIP 备赛记</span></a><a class="item title" href="/2026/01/05/Architecture%20Lab/"><span class="title">CMU CS:APP Architecture Lab</span></a><a class="item title" href="/2025/12/28/Bomb%20Lab/"><span class="title">CMU CS:APP Bomb Lab</span></a><a class="item title" href="/2025/05/02/XCPC2025-2026/"><span class="title">2025-2026 XCPC</span></a><a class="item title" href="/2026/01/23/hash/"><span class="title">卡哈希</span></a><a class="item title" href="/2024/08/13/XOR/"><span class="title">求 $[1,n]$ 的异或和</span></a><a class="item title" href="/2025/01/03/summary24/"><span class="title">2024 年度小结</span></a><a class="item title" href="/2025/12/25/Data%20Lab/"><span class="title">CMU CS:APP Data Lab</span></a><a class="item title" href="/2025/12/28/Attack%20Lab/"><span class="title">CMU CS:APP Attack Lab</span></a><a class="item title" href="/2020/10/19/UVA12167/"><span class="title">题解：UVA12167 Proving Equivalences</span></a></div></widget>
</div>

</div></aside><div class="l_main" id="main">





<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">Home</a>
<span class="sep"></span><a class="cap breadcrumb" href="/">Blog</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/Academy/">Academy</a></div>
<div class="flex-row" id="post-meta"><span class="text created">Posted on: <time datetime="2026-01-04T16:00:00.000Z">2026-01-05</time></span><span class="sep updated"></span><span class="text updated">Updated on: <time datetime="2026-01-25T11:16:26.620Z">2026-01-25</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>CMU CS:APP Architecture Lab</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><h1 id="CS-APP-Architecture-Lab-Report"><a href="#CS-APP-Architecture-Lab-Report" class="headerlink" title="CS:APP Architecture Lab Report"></a>CS:APP Architecture Lab Report</h1><p><strong>Name</strong> SUNCHAOYI  </p>
<p>To fix the build error with older versions of GCC, you’ll need to add the <code>-fcommon</code> to the compiler settings in <code>misc/Makefile</code>, <code>pipe/Makefile</code> and <code>seq/Makefile</code>.</p>
<p>Change <code>CFLAGS=-Wall -O1 -g</code> to <code>CFLAGS=-Wall -O1 -g -fcommon</code>. Then change <code>LCFLAGS=-O1</code> to <code>LCFLAGS=-O1 -fcommon</code>. </p>
<p>Relative Tools : </p>
<ul>
<li><p><strong>yas</strong> Y86 Assembler</p>
</li>
<li><p><strong>yis</strong> Y86 Instruction Set Simulator</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Source code (.ys) → yas assembler → Object file (.yo) → yis simulator</span><br></pre></td></tr></table></figure>
<h2 id="Part-A"><a href="#Part-A" class="headerlink" title="Part A"></a>Part A</h2><h3 id="texttt-sum-ys-Iteratively-sum-linked-list-elements"><a href="#texttt-sum-ys-Iteratively-sum-linked-list-elements" class="headerlink" title="$\texttt{sum.ys}$ Iteratively sum linked list elements"></a>$\texttt{sum.ys}$ Iteratively sum linked list elements</h3><p>Assembly programs execute <strong>sequentially from top to bottom</strong> according to their layout in memory. The <code>.pos 0</code> directive sets the program entry point at address 0. The <code>stack:</code> label is conventionally placed at <code>0x200</code> to separate the code section from the data section and provide dedicated stack space. The expected computation result is $\texttt{0x00a + 0x0b0 + 0xc00 = 0xcba}$. Note that Y86-64 assemblers typically require <strong>a blank line at the end of the source file</strong>.</p>
<h4 id="Reference-solution"><a href="#Reference-solution" class="headerlink" title="Reference solution"></a>Reference solution</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">.pos 0</span><br><span class="line">    irmovq  stack, %rsp</span><br><span class="line">    call    main</span><br><span class="line">    halt</span><br><span class="line">.align 8</span><br><span class="line">ele1:</span><br><span class="line">    .quad 0x00a</span><br><span class="line">    .quad ele2</span><br><span class="line">ele2:</span><br><span class="line">    .quad 0x0b0</span><br><span class="line">    .quad ele3</span><br><span class="line">ele3:</span><br><span class="line">    .quad 0xc00</span><br><span class="line">    .quad 0</span><br><span class="line">main : </span><br><span class="line">   irmovq ele1, %rdi</span><br><span class="line">   call sum</span><br><span class="line">   ret</span><br><span class="line">sum : </span><br><span class="line">    irmovq $0, %rax      # long val = 0;</span><br><span class="line">    jmp test</span><br><span class="line">loop : </span><br><span class="line">    mrmovq (%rdi),%rsi   # val += ls-&gt;val;</span><br><span class="line">    addq %rsi, %rax</span><br><span class="line">    mrmovq 8(%rdi), %rdi # ls = ls-&gt;next;</span><br><span class="line">test :</span><br><span class="line">    andq %rdi, %rdi      # while (ls)</span><br><span class="line">    jne loop             # continue if ls != NULL</span><br><span class="line">    ret                  # return val;</span><br><span class="line">.pos 0x200</span><br><span class="line">stack:</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="Execution-Results"><a href="#Execution-Results" class="headerlink" title="Execution Results"></a>Execution Results</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Stopped in 26 steps at PC = 0x13.  Status &#x27;HLT&#x27;, CC Z=1 S=0 O=0</span><br><span class="line">Changes to registers:</span><br><span class="line">%rax:   0x0000000000000000      0x0000000000000cba</span><br><span class="line">%rsp:   0x0000000000000000      0x0000000000000200</span><br><span class="line">%rsi:   0x0000000000000000      0x0000000000000c00</span><br><span class="line"></span><br><span class="line">Changes to memory:</span><br><span class="line">0x01f0: 0x0000000000000000      0x000000000000005b</span><br><span class="line">0x01f8: 0x0000000000000000      0x0000000000000013</span><br></pre></td></tr></table></figure>
<h3 id="texttt-rsum-ys-Recursively-sum-linked-list-elements"><a href="#texttt-rsum-ys-Recursively-sum-linked-list-elements" class="headerlink" title="$\texttt{rsum.ys}$ Recursively sum linked list elements"></a>$\texttt{rsum.ys}$ Recursively sum linked list elements</h3><ol>
<li>Check base case: <code>if (ptr == NULL) return 0;</code></li>
<li>Save current node value to stack</li>
<li>Recursively call <code>r_sum</code> with next pointer</li>
<li>Pop saved value and add to recursive result</li>
<li>Return final sum</li>
</ol>
<p>Note that Y86-64 does not have a <code>test</code> instruction, use <code>andq</code> for condition checking instead.</p>
<h4 id="Referrence-solution"><a href="#Referrence-solution" class="headerlink" title="Referrence solution"></a>Referrence solution</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">.pos 0</span><br><span class="line">    irmovq  stack, %rsp</span><br><span class="line">    call    main</span><br><span class="line">    halt</span><br><span class="line">.align 8</span><br><span class="line">ele1:</span><br><span class="line">    .quad 0x00a</span><br><span class="line">    .quad ele2</span><br><span class="line">ele2:</span><br><span class="line">    .quad 0x0b0</span><br><span class="line">    .quad ele3</span><br><span class="line">ele3:</span><br><span class="line">    .quad 0xc00</span><br><span class="line">    .quad 0</span><br><span class="line">main : </span><br><span class="line">   irmovq ele1, %rdi</span><br><span class="line">   call r_sum</span><br><span class="line">   ret</span><br><span class="line">r_sum : </span><br><span class="line">    andq %rdi, %rdi          # if (!ls)</span><br><span class="line">    je end                   #   return 0;</span><br><span class="line">    mrmovq (%rdi), %rbx      # long val = ls-&gt;val;</span><br><span class="line">    mrmovq 8(%rdi), %rdi     # ls = ls-&gt;next;</span><br><span class="line">    pushq %rbx               # save val</span><br><span class="line">    call  r_sum              # long rest = rsum_list(ls-&gt;next);</span><br><span class="line">    popq %rbx                # restore val</span><br><span class="line">    addq %rbx,%rax           # return val + rest;</span><br><span class="line">    ret</span><br><span class="line">end :</span><br><span class="line">    irmovq $0, %rax</span><br><span class="line">    ret</span><br><span class="line">.pos 0x200</span><br><span class="line">stack:</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="Execution-Results-1"><a href="#Execution-Results-1" class="headerlink" title="Execution Results"></a>Execution Results</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Stopped in 37 steps at PC = 0x13.  Status &#x27;HLT&#x27;, CC Z=0 S=0 O=0</span><br><span class="line">Changes to registers:</span><br><span class="line">%rax:   0x0000000000000000      0x0000000000000cba</span><br><span class="line">%rbx:   0x0000000000000000      0x000000000000000a</span><br><span class="line">%rsp:   0x0000000000000000      0x0000000000000200</span><br><span class="line"></span><br><span class="line">Changes to memory:</span><br><span class="line">0x01c0: 0x0000000000000000      0x0000000000000086</span><br><span class="line">0x01c8: 0x0000000000000000      0x0000000000000c00</span><br><span class="line">0x01d0: 0x0000000000000000      0x0000000000000086</span><br><span class="line">0x01d8: 0x0000000000000000      0x00000000000000b0</span><br><span class="line">0x01e0: 0x0000000000000000      0x0000000000000086</span><br><span class="line">0x01e8: 0x0000000000000000      0x000000000000000a</span><br><span class="line">0x01f0: 0x0000000000000000      0x000000000000005b</span><br><span class="line">0x01f8: 0x0000000000000000      0x0000000000000013</span><br></pre></td></tr></table></figure>
<h2 id=""><a href="#" class="headerlink" title="#"></a>#</h2><p>Y86-64 does <strong>not</strong> support immediate operands in arithmetic instructions. Instead of <code>addq $8, %rdi</code>, must use <code>irmovq $8, %r8</code> and <code>addq %r8, %rdi</code> instead.</p>
<p>Computes XOR checksum: $\texttt{0x00a} \oplus \texttt{0x0b0} \oplus \texttt{0xc00} = \texttt{0xcba}. Overwrites destination values <code>0x111, 0x222, 0x333</code> with <code>0x00a, 0x0b0, 0xc00</code>.</p>
<h4 id="Reference-Solution"><a href="#Reference-Solution" class="headerlink" title="Reference Solution"></a>Reference Solution</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">.pos 0</span><br><span class="line">    irmovq stack, %rsp</span><br><span class="line">    call main</span><br><span class="line">    halt</span><br><span class="line">.align 8</span><br><span class="line"># Source block</span><br><span class="line">src:</span><br><span class="line">.quad 0x00a</span><br><span class="line">.quad 0x0b0</span><br><span class="line">.quad 0xc00</span><br><span class="line"># Destination block</span><br><span class="line">dest:</span><br><span class="line">.quad 0x111</span><br><span class="line">.quad 0x222</span><br><span class="line">.quad 0x333</span><br><span class="line">main:</span><br><span class="line">    irmovq src, %rdi</span><br><span class="line">    irmovq dest, %rsi</span><br><span class="line">    irmovq $3, %rdx</span><br><span class="line">    call copy</span><br><span class="line">    ret</span><br><span class="line">copy:</span><br><span class="line">    irmovq $0, %rax        # long result = 0;</span><br><span class="line">    irmovq $8, %r8         </span><br><span class="line">    irmovq $1, %r9         </span><br><span class="line">    je test                # jump to condition check</span><br><span class="line">loop:</span><br><span class="line">    mrmovq (%rdi), %r10    # long val = *src++;</span><br><span class="line">    addq %r8, %rdi         #   (src++)</span><br><span class="line">    rmmovq %r10, (%rsi)    # *dest++ = val;</span><br><span class="line">    addq %r8, %rsi         #   (dest++)</span><br><span class="line">    xorq %r10, %rax        # result ^= val;</span><br><span class="line">    subq %r9, %rdx         # len--;  </span><br><span class="line">test:</span><br><span class="line">    andq %rdx, %rdx        # while (len &gt; 0) </span><br><span class="line">    jne loop               # continue if len != 0</span><br><span class="line">    ret                    # return result;</span><br><span class="line">end:</span><br><span class="line">    ret</span><br><span class="line">.pos 0x200</span><br><span class="line">stack: </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="Execution-Results-2"><a href="#Execution-Results-2" class="headerlink" title="Execution Results"></a>Execution Results</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Stopped in 39 steps at PC = 0x13.  Status &#x27;HLT&#x27;, CC Z=1 S=0 O=0</span><br><span class="line">Changes to registers:</span><br><span class="line">%rax:   0x0000000000000000      0x0000000000000cba</span><br><span class="line">%rsp:   0x0000000000000000      0x0000000000000200</span><br><span class="line">%rsi:   0x0000000000000000      0x0000000000000048</span><br><span class="line">%rdi:   0x0000000000000000      0x0000000000000030</span><br><span class="line">%r8:    0x0000000000000000      0x0000000000000008</span><br><span class="line">%r9:    0x0000000000000000      0x0000000000000001</span><br><span class="line">%r10:   0x0000000000000000      0x0000000000000c00</span><br><span class="line"></span><br><span class="line">Changes to memory:</span><br><span class="line">0x0030: 0x0000000000000111      0x000000000000000a</span><br><span class="line">0x0038: 0x0000000000000222      0x00000000000000b0</span><br><span class="line">0x0040: 0x0000000000000333      0x0000000000000c00</span><br><span class="line">0x01f0: 0x0000000000000000      0x000000000000006f</span><br><span class="line">0x01f8: 0x0000000000000000      0x0000000000000013</span><br></pre></td></tr></table></figure>
<h2 id="Part-B"><a href="#Part-B" class="headerlink" title="Part B"></a>Part B</h2><p>To fix the <code>undefined reference to matherr</code> error, <strong>comment out</strong> the unused <code>matherr</code> function declaration in <code>ssim.c</code>.</p>
<p>The goal is to extend the SEQ processor to support the iaddq instruction, which adds an immediate value to a register <code>iaddq V, rB</code> → <code>rB = rB + V</code>.</p>
<h3 id="Fetch-Stage"><a href="#Fetch-Stage" class="headerlink" title="Fetch Stage"></a>Fetch Stage</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bool instr_valid = icode in </span><br><span class="line">	&#123; INOP, IHALT, IRRMOVQ, IIRMOVQ, IRMMOVQ, IMRMOVQ,</span><br><span class="line">	       IOPQ, IJXX, ICALL, IRET, IPUSHQ, IPOPQ, IIADDQ &#125;;</span><br><span class="line">bool need_regids =</span><br><span class="line">	icode in &#123; IRRMOVQ, IOPQ, IPUSHQ, IPOPQ, </span><br><span class="line">		     IIRMOVQ, IRMMOVQ, IMRMOVQ, IIADDQ &#125;;</span><br><span class="line">bool need_valC =</span><br><span class="line">	icode in &#123; IIRMOVQ, IRMMOVQ, IMRMOVQ, IJXX, ICALL,IIADDQ &#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Declare <code>IIADDQ</code> as a valid instruction so the processor recognizes it.</p>
</li>
<li><p><code>IIADDQ</code> needs a register byte to specify <code>rB</code> (the destination register).</p>
</li>
<li><p><code>IIADDQ</code> requires an immediate value <code>V</code>, which is stored in the constant word <code>valC</code>.</p>
</li>
</ul>
<h3 id="Decode-Stage"><a href="#Decode-Stage" class="headerlink" title="Decode Stage"></a>Decode Stage</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">word srcB = [</span><br><span class="line">	icode in &#123; IOPQ, IRMMOVQ, IMRMOVQ, IIADDQ &#125; : rB;</span><br><span class="line">	icode in &#123; IPUSHQ, IPOPQ, ICALL, IRET &#125; : RRSP;</span><br><span class="line">	1 : RNONE;  # Don&#x27;t need register</span><br><span class="line">];</span><br><span class="line">word dstE = [</span><br><span class="line">	icode in &#123; IRRMOVQ &#125; &amp;&amp; Cnd : rB;</span><br><span class="line">	icode in &#123; IIRMOVQ, IOPQ, IIADDQ &#125; : rB;</span><br><span class="line">	icode in &#123; IPUSHQ, IPOPQ, ICALL, IRET &#125; : RRSP;</span><br><span class="line">	1 : RNONE;  # Don&#x27;t write any register</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>IIADDQ</code> needs to read register <code>rB</code> to get its current value (<code>valB = Reg[rB]</code>).</p>
</li>
<li><p><code>IIADDQ</code> writes the result back to register <code>rB</code> (through <code>dstE</code>).</p>
</li>
</ul>
<h3 id="Execute-Stage"><a href="#Execute-Stage" class="headerlink" title="Execute Stage"></a>Execute Stage</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">word aluA = [</span><br><span class="line">	icode in &#123; IRRMOVQ, IOPQ &#125; : valA;</span><br><span class="line">	icode in &#123; IIRMOVQ, IRMMOVQ, IMRMOVQ, IIADDQ &#125; : valC;</span><br><span class="line">	icode in &#123; ICALL, IPUSHQ &#125; : -8;</span><br><span class="line">	icode in &#123; IRET, IPOPQ &#125; : 8;</span><br><span class="line">	# Other instructions don&#x27;t need ALU</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">## Select input B to ALU</span><br><span class="line">word aluB = [</span><br><span class="line">	icode in &#123; IRMMOVQ, IMRMOVQ, IOPQ, ICALL, </span><br><span class="line">		      IPUSHQ, IRET, IPOPQ, IIADDQ &#125; : valB;</span><br><span class="line">	icode in &#123; IRRMOVQ, IIRMOVQ &#125; : 0;</span><br><span class="line">	# Other instructions don&#x27;t need ALU</span><br><span class="line">];</span><br><span class="line">bool set_cc = icode in &#123; IOPQ, IIADDQ &#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>For <code>IIADDQ</code>, <code>aluA</code> uses the immediate value <code>valC</code>.</p>
</li>
<li><p><code>aluB</code> uses <code>valB</code> (the current value of register <code>rB</code>).</p>
</li>
<li><p>Like arithmetic operations (<code>IOPQ</code>), iaddq should update the condition codes (<code>ZF</code>, <code>SF</code>, <code>OF</code>).</p>
</li>
</ul>
<h3 id="Memory-Stage-amp-Program-Counter-Update"><a href="#Memory-Stage-amp-Program-Counter-Update" class="headerlink" title="Memory Stage &amp; Program Counter Update"></a>Memory Stage &amp; Program Counter Update</h3><p>No need to update.</p>
<h3 id="Run-Verification-Tests"><a href="#Run-Verification-Tests" class="headerlink" title="Run Verification Tests"></a>Run Verification Tests</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">cd</span> ../y86-code; make testssim)</span><br><span class="line">(<span class="built_in">cd</span> ../ptest; make SIM=../seq/ssim)</span><br><span class="line">(<span class="built_in">cd</span> ../ptest; make SIM=../seq/ssim TFLAGS=-i)</span><br></pre></td></tr></table></figure>
<h3 id="Expected-Output"><a href="#Expected-Output" class="headerlink" title="Expected Output"></a>Expected Output</h3><p>All tests should pass with messages like:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">asum.seq:ISA Check Succeeds</span><br><span class="line">asumr.seq:ISA Check Succeeds</span><br><span class="line">cjr.seq:ISA Check Succeeds</span><br><span class="line">j-cc.seq:ISA Check Succeeds</span><br><span class="line">poptest.seq:ISA Check Succeeds</span><br><span class="line">prog1.seq:ISA Check Succeeds</span><br><span class="line">prog2.seq:ISA Check Succeeds</span><br><span class="line">prog3.seq:ISA Check Succeeds</span><br><span class="line">prog4.seq:ISA Check Succeeds</span><br><span class="line">prog5.seq:ISA Check Succeeds</span><br><span class="line">prog6.seq:ISA Check Succeeds</span><br><span class="line">prog7.seq:ISA Check Succeeds</span><br><span class="line">prog8.seq:ISA Check Succeeds</span><br><span class="line">pushquestion.seq:ISA Check Succeeds</span><br><span class="line">pushtest.seq:ISA Check Succeeds</span><br><span class="line">ret-hazard.seq:ISA Check Succeeds</span><br><span class="line"></span><br><span class="line">All 49 ISA Checks Succeed</span><br><span class="line">All 64 ISA Checks Succeed</span><br><span class="line">All 22 ISA Checks Succeed</span><br><span class="line">All 600 ISA Checks Succeed</span><br><span class="line"></span><br><span class="line">All 58 ISA Checks Succeed</span><br><span class="line">All 96 ISA Checks Succeed</span><br><span class="line">All 22 ISA Checks Succeed</span><br><span class="line">All 756 ISA Checks Succeed</span><br></pre></td></tr></table></figure>
<h2 id="Part-C"><a href="#Part-C" class="headerlink" title="Part C"></a>Part C</h2><h3 id="Command"><a href="#Command" class="headerlink" title="Command"></a>Command</h3><h4 id="Compilation"><a href="#Compilation" class="headerlink" title="Compilation"></a>Compilation</h4><p>Note that each time you modify your <code>pipe-full.hcl</code> file, you can rebuild the simulator by typing <code>make psim VERSION=full</code>. Each time you modify your <code>ncopy.ys</code> program, you can rebuild the driver programs by typing <code>make drivers</code>. You can type <code>make VERSION=full</code> to rebuild the simulator and the driver programs.</p>
<h4 id="Test-pipe-full-hcl"><a href="#Test-pipe-full-hcl" class="headerlink" title="Test pipe-full.hcl"></a>Test <code>pipe-full.hcl</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ../ptest; make SIM=../pipe/psim</span><br><span class="line"><span class="built_in">cd</span> ../ptest; make SIM=../pipe/psim TFLAGS=-i</span><br></pre></td></tr></table></figure>
<h4 id="Test-your-code-on-a-range-of-block-lengths-with-the-ISA-simulator"><a href="#Test-your-code-on-a-range-of-block-lengths-with-the-ISA-simulator" class="headerlink" title="Test your code on a range of block lengths with the ISA simulator"></a>Test your code on a range of block lengths with the ISA simulator</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./correctness.pl</span><br></pre></td></tr></table></figure>
<h4 id="Partial-Score"><a href="#Partial-Score" class="headerlink" title="Partial Score"></a>Partial Score</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./benchmark.pl</span><br></pre></td></tr></table></figure>
<h3 id="Refference-Solution"><a href="#Refference-Solution" class="headerlink" title="Refference Solution"></a>Refference Solution</h3><ul>
<li><p>Some suggestions in the pdf</p>
<blockquote>
<p>Reordering instructions, replacing groups of instructions with single instructions, deleting some instructions, and adding other instructions. You may ﬁnd it useful to read about loop unrolling.</p>
</blockquote>
</li>
</ul>
<p>First, add <code>IIADDQ</code> instruction support to <code>pipe-full.hcl</code> as required in Part B. Before proceeding to the next step, ensure that your implementation passes all tests similiar to Part B.</p>
<p>Original CPE <code>Average CPE     15.18</code>. Then try to use <code>IIADDQ</code> in the <code>ncopy.ys</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Loop:	</span><br><span class="line">	mrmovq (%rdi), %r10	# read val from src...</span><br><span class="line">	rmmovq %r10, (%rsi)	# ...and store it to dst</span><br><span class="line">	andq %r10, %r10		# val &lt;= 0?</span><br><span class="line">	jle Npos		# if so, goto Npos:</span><br><span class="line">	iaddq $1, %rax		# count++</span><br><span class="line">Npos:	</span><br><span class="line">	iaddq $-1, %rdx		# len--</span><br><span class="line">	iaddq $8, %rdi		# src++</span><br><span class="line">	iaddq $8, %rsi		# dst++</span><br><span class="line">	andq %rdx,%rdx		# len &gt; 0?</span><br><span class="line">	jg Loop			# if so, goto Loop:</span><br></pre></td></tr></table></figure>
<p>The current implementation achieves an <code>Average CPE of 12.70</code>, but the performance score remains at <code>0.0/60.0</code>.</p>
<p>Loop unrolling was attempted to improve performance. After experimentation, $4 \times$ loop unrolling yields with <code>Average CPE of 10.79</code>.</p>
<ol>
<li><p>Default Register Initialization</p>
<p> In Y86-64, registers are initialized to zero by default. Therefore, the explicit <code>xorq %rax,%rax</code> instruction can be omitted, reducing the instruction count.</p>
</li>
<li><p>Loop Unrolling</p>
<p> Subtract the unroll factor from the length counter. If the result is negative, handle remaining elements separately. Otherwise, restore the counter and execute the unrolled loop.</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">    andq %rdx,%rdx</span><br><span class="line">    jle Done</span><br><span class="line"></span><br><span class="line">Loop:	</span><br><span class="line">    iaddq $-4, %rdx</span><br><span class="line">    jl add</span><br><span class="line">work1:</span><br><span class="line">    iaddq $4, %rdx</span><br><span class="line">    mrmovq (%rdi),%r8</span><br><span class="line">    rmmovq %r8, (%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">    jle work2</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work2:</span><br><span class="line">    mrmovq 8(%rdi),%r8</span><br><span class="line">    rmmovq %r8, 8(%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">    jle work3</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work3:</span><br><span class="line">    mrmovq 16(%rdi),%r8</span><br><span class="line">    rmmovq %r8, 16(%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">    jle work4</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work4:</span><br><span class="line">    mrmovq 24(%rdi),%r8</span><br><span class="line">    rmmovq %r8, 24(%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">    jle modify</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">modify:</span><br><span class="line">    iaddq $32,%rdi</span><br><span class="line">    iaddq $32,%rsi</span><br><span class="line">    iaddq $-4,%rdx</span><br><span class="line">    jge Loop</span><br><span class="line">add:</span><br><span class="line">    iaddq $4, %rdx</span><br><span class="line">remain:</span><br><span class="line">    je Done</span><br><span class="line">    mrmovq (%rdi), %r10</span><br><span class="line">    rmmovq %r10, (%rsi)</span><br><span class="line">    andq %r10, %r10</span><br><span class="line">    jle Npos</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">Npos:	</span><br><span class="line">    iaddq $-1, %rdx</span><br><span class="line">    iaddq $8, %rdi</span><br><span class="line">    iaddq $8, %rsi</span><br><span class="line">    andq %rdx,%rdx</span><br><span class="line">    jg remain	</span><br></pre></td></tr></table></figure>
</li>
<li><p>Handle Data hazards</p>
<p> To reduce data hazards in the pipeline, we employ <strong>6-way loop unrolling</strong> with <strong>early loading</strong> of data values by using additional registers (<code>%r8</code>, <code>%r9</code>, <code>%r10</code>, <code>%r11</code>, $\cdots$) to pre‑fetch memory operands. The optimized implementation achieves an <code>average CPE of 7.96</code>.</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">ncopy:</span><br><span class="line">    iaddq $-6, %rdx</span><br><span class="line">    jl res1</span><br><span class="line"></span><br><span class="line">work1:	</span><br><span class="line">    mrmovq (%rdi),%r8</span><br><span class="line">    mrmovq 8(%rdi),%r9</span><br><span class="line">    rmmovq %r8, (%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">    jle work2</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work2:</span><br><span class="line">    rmmovq %r9,8(%rsi)</span><br><span class="line">    mrmovq 16(%rdi),%r10</span><br><span class="line">    andq %r9, %r9</span><br><span class="line">    jle work3</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work3:</span><br><span class="line">    rmmovq %r10,16(%rsi)</span><br><span class="line">    mrmovq 24(%rdi),%r11</span><br><span class="line">    andq %r10, %r10</span><br><span class="line">    jle work4</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work4:</span><br><span class="line">    rmmovq %r11,24(%rsi)</span><br><span class="line">    mrmovq 32(%rdi),%r8</span><br><span class="line">    andq %r11, %r11</span><br><span class="line">    jle work5</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work5:</span><br><span class="line">    rmmovq %r8,32(%rsi)</span><br><span class="line">    mrmovq 40(%rdi),%r9</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">    jle work6</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work6:</span><br><span class="line">    rmmovq %r9,40(%rsi)</span><br><span class="line">    andq %r9, %r9</span><br><span class="line">    jle modify</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">modify:</span><br><span class="line">    iaddq $48,%rdi</span><br><span class="line">    iaddq $48,%rsi</span><br><span class="line">    iaddq $-6,%rdx</span><br><span class="line">    jge work1</span><br><span class="line">res1:</span><br><span class="line">    iaddq $5, %rdx</span><br><span class="line">    jl Done</span><br><span class="line">    mrmovq (%rdi), %r8</span><br><span class="line">    mrmovq 8(%rdi), %r9</span><br><span class="line">    rmmovq %r8, (%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">    jle res2</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">res2:	</span><br><span class="line">    iaddq $-1, %rdx</span><br><span class="line">    jl Done</span><br><span class="line">    mrmovq 16(%rdi), %r10</span><br><span class="line">    rmmovq %r9, 8(%rsi)</span><br><span class="line">    andq %r9, %r9</span><br><span class="line">    jle res3</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">res3:	</span><br><span class="line">    iaddq $-1, %rdx</span><br><span class="line">    jl Done</span><br><span class="line">    mrmovq 24(%rdi), %r11</span><br><span class="line">    rmmovq %r10, 16(%rsi)</span><br><span class="line">    andq %r10, %r10</span><br><span class="line">    jle res4</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">res4:	</span><br><span class="line">    iaddq $-1, %rdx</span><br><span class="line">    jl Done</span><br><span class="line">    mrmovq 32(%rdi), %r8</span><br><span class="line">    rmmovq %r11, 24(%rsi)</span><br><span class="line">    andq %r11, %r11</span><br><span class="line">    jle res5</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">res5:	</span><br><span class="line">    iaddq $-1, %rdx</span><br><span class="line">    jl Done</span><br><span class="line">    rmmovq %r8, 32(%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">    jle Done</span><br><span class="line">    iaddq $1, %rax</span><br></pre></td></tr></table></figure>
</li>
<li><p>Optimaze the Remaining Part</p>
<p> A <strong>tree-like comparison structure</strong> reduces branch instructions by hierarchically testing the remaining length, cutting down the average number of comparisons per iteration. Furthermore, by reordering certain comparison operations, the overall code size has been reduced, enabling higher execution efficiency within the strict byte constraint.</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">iaddq $-10, %rdx</span><br><span class="line">    jl f09</span><br><span class="line">pre:</span><br><span class="line">    mrmovq (%rdi), %r8</span><br><span class="line">    mrmovq 8(%rdi), %r9</span><br><span class="line">    mrmovq 16(%rdi), %r10</span><br><span class="line">    mrmovq 24(%rdi), %r11</span><br><span class="line">    mrmovq 32(%rdi), %r12</span><br><span class="line">    mrmovq 40(%rdi), %r13</span><br><span class="line">    mrmovq 48(%rdi), %r14</span><br><span class="line">    mrmovq 56(%rdi), %rbx</span><br><span class="line">    mrmovq 64(%rdi), %rcx</span><br><span class="line">    mrmovq 72(%rdi), %rbp</span><br><span class="line">work1:	</span><br><span class="line">    rmmovq %r8, (%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">    jle work2</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work2:</span><br><span class="line">    rmmovq %r9, 8(%rsi)</span><br><span class="line">    andq %r9, %r9</span><br><span class="line">    jle work3</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work3:</span><br><span class="line">    rmmovq %r10, 16(%rsi)</span><br><span class="line">    andq %r10, %r10</span><br><span class="line">    jle work4</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work4:</span><br><span class="line">    rmmovq %r11, 24(%rsi)</span><br><span class="line">    andq %r11, %r11</span><br><span class="line">    jle work5</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work5:</span><br><span class="line">    rmmovq %r12, 32(%rsi)</span><br><span class="line">    andq %r12, %r12</span><br><span class="line">    jle work6</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work6:</span><br><span class="line">    rmmovq %r13, 40(%rsi)</span><br><span class="line">    andq %r13, %r13</span><br><span class="line">    jle work7</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work7:</span><br><span class="line">    rmmovq %r14, 48(%rsi)</span><br><span class="line">    andq %r14, %r14</span><br><span class="line">    jle work8</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work8:</span><br><span class="line">    rmmovq %rbx, 56(%rsi)</span><br><span class="line">    andq %rbx, %rbx</span><br><span class="line">    jle work9</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work9:</span><br><span class="line">    rmmovq %rcx, 64(%rsi)</span><br><span class="line">    andq %rcx, %rcx</span><br><span class="line">    jle work10</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work10:</span><br><span class="line">    rmmovq %rbp, 72(%rsi)</span><br><span class="line">    andq %rbp, %rbp</span><br><span class="line">    jle modify</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">modify:</span><br><span class="line">    iaddq $0x50,%rdi</span><br><span class="line">    iaddq $0x50,%rsi</span><br><span class="line">    iaddq $-10,%rdx</span><br><span class="line">    jge pre</span><br><span class="line">f09:</span><br><span class="line">    iaddq $7, %rdx</span><br><span class="line">    jg f49</span><br><span class="line">    jl f02</span><br><span class="line">    je rem3</span><br><span class="line">f02:</span><br><span class="line">    iaddq $2, %rdx</span><br><span class="line">    je rem1</span><br><span class="line">    jg rem2</span><br><span class="line">    jl Done</span><br><span class="line">f46:</span><br><span class="line">    iaddq $2, %rdx</span><br><span class="line">    jl rem4</span><br><span class="line">    je rem5</span><br><span class="line">    jg rem6</span><br><span class="line">f49:</span><br><span class="line">    iaddq $-4, %rdx</span><br><span class="line">    jl f46</span><br><span class="line">    je rem7</span><br><span class="line">f89:</span><br><span class="line">    iaddq $-2, %rdx</span><br><span class="line">    jl rem8</span><br><span class="line">rem9:</span><br><span class="line">    mrmovq 0x40(%rdi), %r8</span><br><span class="line">    rmmovq %r8, 0x40(%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">    jle rem8</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">rem8:</span><br><span class="line">    mrmovq 0x38(%rdi), %r8</span><br><span class="line">    rmmovq %r8, 0x38(%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">    jle rem7</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">rem7:</span><br><span class="line">    mrmovq 0x30(%rdi), %r8</span><br><span class="line">    rmmovq %r8, 0x30(%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">    jle rem6</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">rem6:</span><br><span class="line">    mrmovq 0x28(%rdi), %r8</span><br><span class="line">    rmmovq %r8, 0x28(%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">    jle rem5</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">rem5:</span><br><span class="line">    mrmovq 0x20(%rdi), %r8</span><br><span class="line">    rmmovq %r8, 0x20(%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">    jle rem4</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">rem4:</span><br><span class="line">    mrmovq 0x18(%rdi), %r8</span><br><span class="line">    rmmovq %r8, 0x18(%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">    jle rem3</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">rem3:</span><br><span class="line">    mrmovq 0x10(%rdi), %r8</span><br><span class="line">    rmmovq %r8, 0x10(%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">    jle rem2</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">rem2:</span><br><span class="line">    mrmovq 0x8(%rdi), %r8</span><br><span class="line">    rmmovq %r8, 0x8(%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">    jle rem1</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">rem1:</span><br><span class="line">    mrmovq (%rdi), %r8</span><br><span class="line">    rmmovq %r8, (%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">    jle Done</span><br><span class="line">    iaddq $1, %rax</span><br></pre></td></tr></table></figure>
<p> The average CPE has improved to <code>7.66</code>.</p>
<p>The remainder cases are handled using a carefully structured decision tree. Special attention must be paid to the interleaving of <code>mrmovq</code> and <code>andq</code> instructions, as they directly affect global condition codes. Specifically, the <code>jle</code> instruction condition <code>(SF ^ OF) | ZF = 1</code> requires precise control over flag states. This ensures that <code>jl</code> or <code>jg</code> branches correctly direct execution to the appropriate remainder-handling routines; otherwise, incorrect flag propagation could lead to erroneous counting. (<a target="_blank" rel="noopener" href="https://blog.csdn.net/Leafing_/article/details/130207471">Reference Article</a>)</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">    iaddq $-10, %rdx</span><br><span class="line">    jl f09</span><br><span class="line">pre:</span><br><span class="line">    mrmovq (%rdi), %r8</span><br><span class="line">    mrmovq 8(%rdi), %r9</span><br><span class="line">    mrmovq 16(%rdi), %r10</span><br><span class="line">    mrmovq 24(%rdi), %r11</span><br><span class="line">    mrmovq 32(%rdi), %r12</span><br><span class="line">    mrmovq 40(%rdi), %r13</span><br><span class="line">    mrmovq 48(%rdi), %r14</span><br><span class="line">    mrmovq 56(%rdi), %rbx</span><br><span class="line">    mrmovq 64(%rdi), %rcx</span><br><span class="line">    mrmovq 72(%rdi), %rbp</span><br><span class="line">work1:	</span><br><span class="line">    rmmovq %r8, (%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">    jle work2</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work2:</span><br><span class="line">    rmmovq %r9, 8(%rsi)</span><br><span class="line">    andq %r9, %r9</span><br><span class="line">    jle work3</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work3:</span><br><span class="line">    rmmovq %r10, 16(%rsi)</span><br><span class="line">    andq %r10, %r10</span><br><span class="line">    jle work4</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work4:</span><br><span class="line">    rmmovq %r11, 24(%rsi)</span><br><span class="line">    andq %r11, %r11</span><br><span class="line">    jle work5</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work5:</span><br><span class="line">    rmmovq %r12, 32(%rsi)</span><br><span class="line">    andq %r12, %r12</span><br><span class="line">    jle work6</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work6:</span><br><span class="line">    rmmovq %r13, 40(%rsi)</span><br><span class="line">    andq %r13, %r13</span><br><span class="line">    jle work7</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work7:</span><br><span class="line">    rmmovq %r14, 48(%rsi)</span><br><span class="line">    andq %r14, %r14</span><br><span class="line">    jle work8</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work8:</span><br><span class="line">    rmmovq %rbx, 56(%rsi)</span><br><span class="line">    andq %rbx, %rbx</span><br><span class="line">    jle work9</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work9:</span><br><span class="line">    rmmovq %rcx, 64(%rsi)</span><br><span class="line">    andq %rcx, %rcx</span><br><span class="line">    jle work10</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">work10:</span><br><span class="line">    rmmovq %rbp, 72(%rsi)</span><br><span class="line">    andq %rbp, %rbp</span><br><span class="line">    jle modify</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">modify:</span><br><span class="line">    iaddq $0x50,%rdi</span><br><span class="line">    iaddq $0x50,%rsi</span><br><span class="line">    iaddq $-10,%rdx</span><br><span class="line">    jge pre</span><br><span class="line">f09:</span><br><span class="line">    iaddq $7, %rdx</span><br><span class="line">    jg f49</span><br><span class="line">    jl f02</span><br><span class="line">    je rem3</span><br><span class="line">f02:</span><br><span class="line">    iaddq $2, %rdx</span><br><span class="line">    je rem1</span><br><span class="line">    iaddq $-1, %rdx</span><br><span class="line">    je rem2</span><br><span class="line">    ret</span><br><span class="line">f49:</span><br><span class="line">    iaddq $-3, %rdx</span><br><span class="line">    jg f79</span><br><span class="line">    je rem6</span><br><span class="line">    iaddq $1, %rdx</span><br><span class="line">    je rem5</span><br><span class="line">    jmp rem4</span><br><span class="line">f79:</span><br><span class="line">    iaddq $-2, %rdx</span><br><span class="line">    jl rem7</span><br><span class="line">    je rem8</span><br><span class="line">rem9:</span><br><span class="line">    mrmovq 64(%rdi), %r8</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">    rmmovq %r8, 64(%rsi)</span><br><span class="line">rem8:</span><br><span class="line">    mrmovq 56(%rdi), %r8</span><br><span class="line">    jle ex9</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">ex9:</span><br><span class="line">    rmmovq %r8, 56(%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">rem7:</span><br><span class="line">    mrmovq 48(%rdi), %r8</span><br><span class="line">    jle ex8</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">ex8:</span><br><span class="line">    rmmovq %r8, 48(%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">rem6:</span><br><span class="line">    mrmovq 40(%rdi), %r8</span><br><span class="line">    jle ex7</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">ex7:</span><br><span class="line">    rmmovq %r8, 40(%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">rem5:</span><br><span class="line">    mrmovq 32(%rdi), %r8</span><br><span class="line">    jle ex6</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">ex6:</span><br><span class="line">    rmmovq %r8, 32(%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">rem4:</span><br><span class="line">    mrmovq 24(%rdi), %r8</span><br><span class="line">    jle ex5</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">ex5:</span><br><span class="line">    rmmovq %r8, 24(%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">rem3:</span><br><span class="line">    mrmovq 16(%rdi), %r8</span><br><span class="line">    jle ex4</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">ex4:</span><br><span class="line">    rmmovq %r8, 16(%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">rem2:</span><br><span class="line">    mrmovq 8(%rdi), %r8</span><br><span class="line">    jle ex3</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">ex3:</span><br><span class="line">    rmmovq %r8, 8(%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">rem1:</span><br><span class="line">    mrmovq (%rdi), %r8</span><br><span class="line">    jle ex2</span><br><span class="line">    iaddq $1, %rax</span><br><span class="line">ex2:</span><br><span class="line">    rmmovq %r8, (%rsi)</span><br><span class="line">    andq %r8, %r8</span><br><span class="line">    jle Done</span><br><span class="line">    iaddq $1, %rax</span><br></pre></td></tr></table></figure>
<p> After implementing comprehensive pipeline optimizations including register preloading and careful remainder handling, the implementation achieved:</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Average CPE     7.50</span><br><span class="line">Score   60.0/60.0</span><br></pre></td></tr></table></figure>
</li>
<li><p>Modify HCL (extra)</p>
<p> The expression <code>E_icode in { IMRMOVQ, IPOPQ } &amp;&amp; E_dstM in { d_srcA, d_srcB }</code> identifies load/use hazards in the pipeline. </p>
<p> |Instruction\Cycle|1|2|3|4|5|6|<br> |:—:|:—:|:—:|:—:|:—:|:—:|:—:|<br> |<code>mrmov I1(%rax) %rbx</code>|F|D|E|<strong>M</strong>|W||<br> |<code>rmmov %rbx I2(%rax)</code>||F|D|E|M|<strong>W</strong>|</p>
<p> In the pipeline timeline, the first instruction reads data from memory during its Memory stage (cycle 4). The second instruction needs that same data during its own Memory stage (cycle 5). Because the data is available one cycle before it is needed, forwarding is possible: the value from <code>m_valM</code> can be routed directly to the <code>valA</code> field in the next instruction’s pipeline register, bypassing the register file.</p>
<p> Load forwarding works when two conditions are met:  </p>
<ol>
<li>The current instruction loads a value from memory into a register (e.g., <code>mrmovq</code> or <code>popq</code>) and uses that register as the source operand.  </li>
<li><p>The next instruction uses that same register as a source operand <strong>not in its Execute stage</strong>, but only later, during its Memory stage — typically in store-type instructions such as <code>rmmovq</code> or <code>pushq</code>.  </p>
<p>To support this, a forwarding path is added that connects the memory output signal <code>m_valM</code> to the <code>valA</code> input of the pipeline register M, allowing it to be passed directly to <code>e_valA</code> in the following instruction. Formally, the forwarding condition can be expressed as <code>E_icode in { IMRMOVQ, IPOPQ } &amp;&amp; E_srcA == M_dstM</code>. Therefore, only the following control logic will trigger load/use hazard handling:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E_icode in &#123; IMRMOVQ, IPOPQ &#125; &amp;&amp; (E_dstM == d_srcB || (E_dstM == d_srcA &amp;&amp; !(D_icode in &#123; IMRMOVQ, IPUSHQ &#125;)))</span><br></pre></td></tr></table></figure>
<p>The logic for <code>e_valA</code> in the Execute stage must be updated to select the forwarded value from memory when applicable:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">word e_valA = [</span><br><span class="line">E_icode in &#123; IRMMOVQ, IPUSHQ &#125; &amp;&amp; E_srcA == M_dstM: m_valM;</span><br><span class="line">    1 : E_valA;  # Use valA from stage pipe register</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>The pipeline control logic must also be adjusted to handle load/use hazards appropriately:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">bool F_bubble = 0;</span><br><span class="line">bool F_stall =</span><br><span class="line">    # Conditions for a load/use hazard</span><br><span class="line">    (E_icode in &#123; IMRMOVQ, IPOPQ &#125; &amp;&amp; (E_dstM == d_srcB || (E_dstM == d_srcA &amp;&amp; !(D_icode in &#123; IMRMOVQ, IPUSHQ &#125;)))) ||</span><br><span class="line">    # Stalling at fetch while ret passes through pipeline</span><br><span class="line">    IRET in &#123; D_icode, E_icode, M_icode &#125;;</span><br><span class="line"></span><br><span class="line"># Should I stall or inject a bubble into Pipeline Register D?</span><br><span class="line"># At most one of these can be true.</span><br><span class="line">bool D_stall = </span><br><span class="line">    # Conditions for a load/use hazard</span><br><span class="line">    E_icode in &#123; IMRMOVQ, IPOPQ &#125; &amp;&amp;</span><br><span class="line">    (E_dstM == d_srcB || (E_dstM == d_srcA &amp;&amp; !(D_icode in &#123; IMRMOVQ, IPUSHQ &#125;)));</span><br><span class="line"></span><br><span class="line">bool D_bubble =</span><br><span class="line">    # Mispredicted branch</span><br><span class="line">    (E_icode == IJXX &amp;&amp; !e_Cnd) ||</span><br><span class="line">    # Stalling at fetch while ret passes through pipeline</span><br><span class="line">    # but not condition for a load/use hazard</span><br><span class="line">    !(E_icode in &#123; IMRMOVQ, IPOPQ &#125; &amp;&amp; (E_dstM == d_srcB || (E_dstM == d_srcA &amp;&amp; !(D_icode in &#123; IMRMOVQ, IPUSHQ &#125;)))) &amp;&amp;</span><br><span class="line">    IRET in &#123; D_icode, E_icode, M_icode &#125;;</span><br><span class="line"></span><br><span class="line"># Should I stall or inject a bubble into Pipeline Register E?</span><br><span class="line"># At most one of these can be true.</span><br><span class="line">bool E_stall = 0;</span><br><span class="line">bool E_bubble =</span><br><span class="line">    # Mispredicted branch</span><br><span class="line">    (E_icode == IJXX &amp;&amp; !e_Cnd) ||</span><br><span class="line">    # Conditions for a load/use hazard</span><br><span class="line">    (E_icode in &#123; IMRMOVQ, IPOPQ &#125; &amp;&amp; (E_dstM == d_srcB || (E_dstM == d_srcA &amp;&amp; !(D_icode in &#123; IMRMOVQ, IPUSHQ &#125;))));</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
</article>
<div class="article-footer">
    <section id="license">
      <div class="header"><span>License</span></div>
      <div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div>
    </section>
    


    <section id="share">
      <div class="header"><span>Share</span></div>
      <div class="body">
        <div class="link"><input class="copy-area" readonly="true" id="copy-link" value="https://sunchaoyi923.github.io/2026/01/05/Architecture%20Lab/" /></div>
        <div class="social-wrap dis-select"><a class="social share-item wechat" onclick="util.toggle(&quot;qrcode-wechat&quot;)"><img  src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/b32ef3da1162a.svg" /></a><a class="social share-item email" href="mailto:?subject=CMU CS:APP Architecture Lab - SUNCHAOYI&amp;body=https://sunchaoyi923.github.io/2026/01/05/Architecture%20Lab/"><img  src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/a1b00e20f425d.svg" /></a><a class="social share-item link" onclick="util.copy(&quot;copy-link&quot;, &quot;Copied!&quot;)"><img  src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/8411ed322ced6.svg" /></a></div>
        
        <div class="qrcode" id="qrcode-wechat" style="opacity:0;height:0">
          <img src="https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=https://sunchaoyi923.github.io/2026/01/05/Architecture%20Lab/"/>
        </div>
        
      </div>
    </section>
    </div>

<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">Newer</div><a href="/2026/01/23/hash/">卡哈希</a></div><div class="item" id="next"><div class="note">Older</div><a href="/2026/01/01/CUHKSZ%20Notes/">CUHK-Shenzhen Notes</a></div></section></div>






<footer class="page-footer footnote"><hr><div class="text"><p>本站由 <a href="/">Chaoyi, Sun</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.33.1">Stellar 1.33.1</a> 主题创建。<br>本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">On This Page</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CS-APP-Architecture-Lab-Report"><span class="toc-text">CS:APP Architecture Lab Report</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Part-A"><span class="toc-text">Part A</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#texttt-sum-ys-Iteratively-sum-linked-list-elements"><span class="toc-text">$\texttt{sum.ys}$ Iteratively sum linked list elements</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Reference-solution"><span class="toc-text">Reference solution</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Execution-Results"><span class="toc-text">Execution Results</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#texttt-rsum-ys-Recursively-sum-linked-list-elements"><span class="toc-text">$\texttt{rsum.ys}$ Recursively sum linked list elements</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Referrence-solution"><span class="toc-text">Referrence solution</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Execution-Results-1"><span class="toc-text">Execution Results</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-text">#</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Reference-Solution"><span class="toc-text">Reference Solution</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Execution-Results-2"><span class="toc-text">Execution Results</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Part-B"><span class="toc-text">Part B</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Fetch-Stage"><span class="toc-text">Fetch Stage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Decode-Stage"><span class="toc-text">Decode Stage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Execute-Stage"><span class="toc-text">Execute Stage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Memory-Stage-amp-Program-Counter-Update"><span class="toc-text">Memory Stage &amp; Program Counter Update</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Run-Verification-Tests"><span class="toc-text">Run Verification Tests</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Expected-Output"><span class="toc-text">Expected Output</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Part-C"><span class="toc-text">Part C</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Command"><span class="toc-text">Command</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Compilation"><span class="toc-text">Compilation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Test-pipe-full-hcl"><span class="toc-text">Test pipe-full.hcl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Test-your-code-on-a-range-of-block-lengths-with-the-ISA-simulator"><span class="toc-text">Test your code on a range of block lengths with the ISA simulator</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Partial-Score"><span class="toc-text">Partial Score</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Refference-Solution"><span class="toc-text">Refference Solution</span></a></li></ol></li></ol></li></ol></div><div class="widget-footer"><a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Solar by 480 Design - https://creativecommons.org/licenses/by/4.0/ --><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5"><path stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/><path d="M7 3.338A9.95 9.95 0 0 1 12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12c0-1.821.487-3.53 1.338-5"/></g></svg><span>Scroll to Top</span></a></div></widget>
</div></aside><div class='float-panel'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">


<script type="text/javascript">
  window.canonical = {"originalHost":null,"officialHosts":["localhost"],"encoded":""};
  const ctx = {
    date_suffix: {
      just: `Just`,
      min: `minutes ago`,
      hour: `hours ago`,
      day: `days ago`,
    },
    root : `/`,
    tag_plugins: {
      chat: Object.assign({"api":"https://siteinfo.listentothewind.cn/api/v1"}),
    }
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"skip_search":[],"codeblock":true,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
    loading: `https://api.iconify.design/eos-icons:three-dots-loading.svg?color=%231cd0fd`,
  };
  const deps = {
    jquery: `https://gcore.jsdelivr.net/npm/jquery@3.7/dist/jquery.min.js`,
    marked: `https://gcore.jsdelivr.net/npm/marked@13.0/lib/marked.umd.min.js`,
    lazyload: `/%5Bobject%20Object%5D`
  }
  

</script>

<script type="text/javascript">
  
  function RunItem() {
    this.list = []; // 存放回调函数
    this.start = () => {
      for (var i = 0; i < this.list.length; i++) {
        this.list[i].run();
      }
    };
    this.push = (fn, name, setRequestAnimationFrame = true) => {
      let myfn = fn
      if (setRequestAnimationFrame) {
        myfn = () => {
          utils.requestAnimationFrame(fn)
        }
      }
      var f = new Item(myfn, name);
      this.list.push(f);
    };
    this.remove = (name) => {
      for (let index = 0; index < this.list.length; index++) {
        const e = this.list[index];
        if (e.name == name) {
          this.list.splice(index, 1);
        }
      }
    }
    // 构造一个可以run的对象
    function Item(fn, name) {
      // 函数名称
      this.name = name || fn.name;
      // run方法
      this.run = () => {
        try {
          fn()
        } catch (error) {
          console.log(error);
        }
      };
    }
  }

  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')) {
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function () {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },

    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      const maxRetry = 3;
      let retryCount = 0;

      return new Promise((resolve, reject) => {
        const load = () => {
          utils.onLoading?.(el);

          let timedOut = false;
          const timeout = setTimeout(() => {
            timedOut = true;
            console.warn('[request] 超时:', url);

            if (++retryCount >= maxRetry) {
              utils.onLoadFailure?.(el);
              onFailure?.();
              reject('请求超时');
            } else {
              setTimeout(load, 1000);
            }
          }, 5000);

          fetch(url).then(resp => {
            if (timedOut) return;
            clearTimeout(timeout);

            if (!resp.ok) throw new Error('响应失败');
            return resp;
          }).then(data => {
            if (timedOut) return;
            utils.onLoadSuccess?.(el);
            callback(data);
            resolve(data);
          }).catch(err => {
            clearTimeout(timeout);
            console.warn('[request] 错误:', err);

            if (++retryCount >= maxRetry) {
              utils.onLoadFailure?.(el);
              onFailure?.();
              reject(err);
            } else {
              setTimeout(load, 1000);
            }
          });
        };

        load();
      });
    },
    requestWithoutLoading: (url, options = {}, maxRetry = 2, timeout = 5000) => {
      return new Promise((resolve, reject) => {
        let retryCount = 0;

        const tryRequest = () => {
          let timedOut = false;
          const timer = setTimeout(() => {
            timedOut = true;
            if (++retryCount > maxRetry) reject('timeout');
            else tryRequest();
          }, timeout);

          fetch(url, options)
            .then(resp => {
              clearTimeout(timer);
              if (!resp.ok) throw new Error('bad response');
              resolve(resp);
            })
            .catch(err => {
              clearTimeout(timer);
              if (++retryCount > maxRetry) reject(err);
              else setTimeout(tryRequest, 500);
            });
        };

        tryRequest();
      });
    },
    /********************** requestAnimationFrame ********************************/
    // 1、requestAnimationFrame 会把每一帧中的所有 DOM 操作集中起来，在一次重绘或回流中就完成，并且重绘或回流的时间间隔紧紧跟随浏览器的刷新频率，一般来说，这个频率为每秒60帧。
    // 2、在隐藏或不可见的元素中，requestAnimationFrame 将不会进行重绘或回流，这当然就意味着更少的的 cpu，gpu 和内存使用量。
    requestAnimationFrame: (fn) => {
      if (!window.requestAnimationFrame) {
        window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame;
      }
      window.requestAnimationFrame(fn)
    },
    dark: {},
  };

  // utils.dark.mode 当前模式 dark or light
  // utils.dark.toggle() 暗黑模式触发器
  // utils.dark.push(callBack[,"callBackName"]) 传入触发器回调函数
  utils.dark.method = {
    toggle: new RunItem(),
  };
  utils.dark = Object.assign(utils.dark, {
    push: utils.dark.method.toggle.push,
  });
</script>
<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>
<script type="text/javascript">
  (() => {
    const tagSwitchers = document.querySelectorAll('.tag-subtree.parent-tag > a > .tag-switcher-wrapper')
    for (const tagSwitcher of tagSwitchers) {
      tagSwitcher.addEventListener('click', (e) => {
        const parent = e.target.closest('.tag-subtree.parent-tag')
        parent.classList.toggle('expanded')
        e.preventDefault()
      })
    }

    // Get active tag from query string, then activate it.
    const urlParams = new URLSearchParams(window.location.search)
    const activeTag = urlParams.get('tag')
    if (activeTag) {
      let tag = document.querySelector(`.tag-subtree[data-tag="${activeTag}"]`)
      if (tag) {
        tag.querySelector('a').classList.add('active')
        
        while (tag) {
          tag.classList.add('expanded')
          tag = tag.parentElement.closest('.tag-subtree.parent-tag')
        }
      }
    }
  })()
</script>

<script async src="https://gcore.jsdelivr.net/npm/vanilla-lazyload@19.1/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
    callback_loaded: (el) => {
      el.classList.add('loaded');
      const wrapper = el.closest('.lazy-box');
      const icon = wrapper?.querySelector('.lazy-icon');
      if (icon) icon.remove();
    }
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });

  window.wrapLazyloadImages = (container) => {
    if (typeof container === 'string') {
      container = document.querySelector(container);
    }
    if (!container) return;
    
    const images = container.querySelectorAll('img');
    images.forEach((img) => {
      if (img.classList.contains('lazy')) return;

      const src = img.getAttribute('src');
      if (!src) return;

      const wrapper = document.createElement('div');
      wrapper.className = 'lazy-box';

      const newImg = img.cloneNode();
      newImg.removeAttribute('src');
      newImg.setAttribute('data-src', src);
      newImg.classList.add('lazy');

      const icon = document.createElement('div');
      icon.className = 'lazy-icon';
      if (def.loading) {
        icon.style.backgroundImage = `url("${def.loading}")`;
      }

      wrapper.appendChild(newImg);
      wrapper.appendChild(icon);

      img.replaceWith(wrapper);
    });

    // 通知 LazyLoad 更新
    if (window.lazyLoadInstance?.update) {
      window.lazyLoadInstance.update();
    }
  }
  
</script>

<!-- required -->
<script src="/js/main.js?v=1.33.1" defer></script>

<script type="text/javascript">
  const applyTheme = (theme) => {
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme')
    } else {
      document.documentElement.setAttribute('data-theme', theme)
    }

    // applyThemeToGiscus(theme)
  }

  // FIXME: 这会导致无法使用 preferred_color_scheme 以外的主题
  const applyThemeToGiscus = (theme) => {
    // theme = theme === 'auto' ? 'preferred_color_scheme' : theme
    const cmt = document.getElementById('giscus')
    if (cmt) {
      // This works before giscus load.
      cmt.setAttribute('data-theme', theme)
    }

    const iframe = document.querySelector('#comments > section.giscus > iframe')
    if (iframe) {
      // This works after giscus loaded.
      const src = iframe.src
      const newSrc = src.replace(/theme=[\w]+/, `theme=${theme}`)
      iframe.src = newSrc
    }
  }

  const switchTheme = () => {
    // light -> dark -> auto -> light -> ...
    const currentTheme = document.documentElement.getAttribute('data-theme')
    let newTheme;
    switch (currentTheme) {
      case 'light':
        newTheme = 'dark'
        break
      case 'dark':
        newTheme = 'auto'
        break
      default:
        newTheme = 'light'
    }
    applyTheme(newTheme)
    window.localStorage.setItem('Stellar.theme', newTheme)
    utils.dark.mode = newTheme === 'auto' ? (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light") : newTheme;
    utils.dark.method.toggle.start();

    const messages = {
      light: `Switched to Light Mode`,
      dark: `Switched to Dark Mode`,
      auto: `Switched to Auto Mode`,
    }
    hud?.toast?.(messages[newTheme])
  }

  (() => {
    // Apply user's preferred theme, if any.
    const theme = window.localStorage.getItem('Stellar.theme')
    if (theme !== null) {
      applyTheme(theme)
    } else {
      utils.dark.mode = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    }
    utils.dark.method.toggle.start();
  })()
</script>


<!-- optional -->



<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"rating":{"js":"/js/services/rating.js","api":"https://star-vote.xaox.cc/api/rating"},"vote":{"js":"/js/services/vote.js","api":"https://star-vote.xaox.cc/api/vote"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"friends_and_posts":{"js":"/js/services/friends_and_posts.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"},"voice":{"js":"/js/plugins/voice.js"},"video":{"js":"/js/plugins/video.js"},"download-file":{"js":"/js/plugins/download-file.js"},"twikoo":{"js":"/js/services/twikoo_latest_comment.js"},"waline":{"js":"/js/services/waline_latest_comment.js"},"artalk":{"js":"/js/services/artalk_latest_comment.js"},"giscus":{"js":"/js/services/giscus_latest_comment.js"},"contributors":{"edit_this_page":{"_posts/":null,"wiki/stellar/":"https://github.com/xaoxuu/hexo-theme-stellar-docs/blob/main/"},"js":"/js/services/contributors.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else if (id == 'voice') {
        ctx.voiceAudios = document.querySelectorAll('.voice>audio');
        if (ctx.voiceAudios?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            createVoiceDom(ctx.voiceAudios);
          });
        }
      } else if (id == 'video') {
        ctx.videos = document.querySelectorAll('.video>video');
        if (ctx.videos?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            videoEvents(ctx.videos);
          });
        }
      } else if (id == 'download-file') {
        ctx.files = document.querySelectorAll('.file');
        if (ctx.files?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            downloadFileEvent(ctx.files);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }

    // chat iphone time
    let phoneTimes = document.querySelectorAll('.chat .status-bar .time');

    if (phoneTimes.length > 0) {
      NowTime();
      var date = new Date();
      var sec = date.getSeconds();
      var firstAdjustInterval = setInterval(firstAdjustTime, 1000 * (60 - sec));
    }

    function firstAdjustTime() {
      NowTime();
      clearInterval(firstAdjustInterval);
      setInterval(NowTime, 1000 * 60);
    }

    function NowTime() {
      for (let i = 0; i < phoneTimes.length; ++i) {
        var timeSpan = phoneTimes[i];
        var date = new Date();
        var hour = date.getHours();
        var min = date.getMinutes();
        timeSpan.innerHTML = check(hour) + ":" + check(min);
      }
    };

    function check(val) {
      if (val < 10) {
        return ("0" + val);
      }
      return (val);
    }

    // chat quote
    const chat_quote_obverser = new IntersectionObserver((entries, observer) => {
      entries.filter((entry) => { return entry.isIntersecting }).sort((a, b) => a.intersectionRect.y !== b.intersectionRect.y ? a.intersectionRect.y - b.intersectionRect.y : a.intersectionRect.x - b.intersectionRect.x).forEach((entry, index) => {
          observer.unobserve(entry.target);
          setTimeout(() => {
            entry.target.classList.add('quote-blink');
            setTimeout(() => {
              entry.target.classList.remove('quote-blink');
            }, 1000);
          }, Math.max(100, 16) * (index + 1));
        });
    });

    var chatQuotes = document.querySelectorAll(".chat .talk .quote");
    chatQuotes.forEach((quote) => {
      quote.addEventListener('click', function () {
        var chatCellDom = document.getElementById("quote-" + quote.getAttribute("quotedCellTag"));
        if (chatCellDom) {
          var chatDiv = chatCellDom.parentElement;
          var mid = chatDiv.clientHeight / 2;
          var offsetTop = chatCellDom.offsetTop;
          if (offsetTop > mid - chatCellDom.clientHeight / 2) {
            chatDiv.scrollTo({
              top: chatCellDom.offsetTop - mid + chatCellDom.clientHeight / 2,
              behavior: "smooth"
            });
          } else {
            chatDiv.scrollTo({
              top: 0,
              behavior: "smooth"
            });
          }
          chat_quote_obverser.observe(chatCellDom);
        }
      });
    });
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://gcore.jsdelivr.net/npm/flying-pages@2/flying-pages.min.js"></script><script>
  ctx.fancybox = {
    selector: `.timenode p>img`,
    css: `https://gcore.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css`,
    js: `https://gcore.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js`
  };
  var selector = '[data-fancybox]:not(.error), .with-fancybox .atk-content img:not([atk-emoticon])';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const memos = document.getElementsByClassName('ds-memos');
    if (memos != undefined && memos.length > 0) {
      needFancybox = true;
    }
    const fancybox = document.getElementsByClassName('with-fancybox');
    if (fancybox != undefined && fancybox.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>

<script id="MathJax-script" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML" async></script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `复制成功`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
